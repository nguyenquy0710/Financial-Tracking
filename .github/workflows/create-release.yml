name: 'Release: Create GitHub Release'
run-name: 'Create GitHub Release by @${{ github.actor }} on ${{ github.event_name }}'

on:
  workflow_dispatch: # ‚úÖ Cho ph√©p ch·∫°y th·ªß c√¥ng
  repository_dispatch: # ‚úÖ Cho ph√©p k√≠ch ho·∫°t t·ª´ b√™n ngo√†i (v√≠ d·ª•: t·ª´ m·ªôt workflow kh√°c)
  push:
    tags:
      - 'v*' # Ch·ªâ k√≠ch ho·∫°t khi c√≥ tag d·∫°ng v*
  # release:
  #   # created : # ‚úÖ Ch·ªâ ch·∫°y khi release ƒë∆∞·ª£c t·∫°o
  #   # published: # ‚úÖ Ch·ªâ ch·∫°y khi release ƒë∆∞·ª£c ph√°t h√†nh
  #   types: [published] # ‚úÖ Ch·ªâ ch·∫°y khi release ƒë∆∞·ª£c ph√°t h√†nh

# Remove all permissions by default
permissions: write-all # ‚ö†Ô∏è N·∫øu kh√¥ng c·∫ßn ghi t·∫•t c·∫£, b·∫°n n√™n d√πng principle of least privilege

env:
  SERVER: production
  BRANCH: ${{ github.ref_name }}
  REPO_NAME: # ‚úÖ S·∫Ω ƒë∆∞·ª£c g√°n ƒë·ªông trong steps
  REPOSITORY: ${{ github.repository }}
  # ‚úÖ Default n·∫øu kh√¥ng ƒë·ªçc t·ª´ file VERSION
  # VERSION: ${{ ((github.ref_type == 'branch' && github.ref_name == 'main') || (github.ref_type == 'tag')) && format('1.0.{0}', github.run_number) || format('1.0.{0}-dev', github.run_number) }}
  VERSION: >-
    ${{
      github.ref_type == 'branch' && github.ref_name == 'main'
        && format('1.0.{0}-main', github.run_number)
        || github.ref_type == 'tag'
        && format('1.0.{0}', github.run_number)
        || format('1.0.{0}-dev', github.run_number)
    }}

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.12'
          registry-url: 'https://registry.npmjs.org/'

      # 3. Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.11.0
          run_install: |
            - recursive: true
              args: [--frozen-lockfile, --strict-peer-dependencies]
            - args: [--global, gulp, eslint, typescript]

      # 4. Install dependencies
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 5. Run Lint + Prepublish build
      - name: Build and Lint
        run: pnpm run prepublishOnly

      # 6. Build package
      - name: Build
        run: pnpm run build

      # 7. T·∫°o CHANGELOG.md t·ª´ commit history
      - name: Generate CHANGELOG.md
        run: |
          echo "üéâ T·ª± ƒë·ªông t·∫°o release cho tag ${{ github.ref_name }}" > changelog.md
          echo "" >> changelog.md
          echo "## ${GITHUB_REF_NAME}" > changelog.md
          echo "" >> changelog.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> changelog.md

      # 8. ƒê√≥ng g√≥i release files
      - name: Package release files
        run: |
          mkdir release
          cp -r dist release/
          cp README.md LICENSE changelog.md release/
          cd release && zip -r ../n8n-nodes-nqdev-${{ github.ref_name }}.zip .

      # 9. Create GitHub Release with asset
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: changelog.md
          files: |
            n8n-nodes-nqdev-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
