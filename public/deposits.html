<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï Ti·∫øt Ki·ªám / ƒê·∫ßu T∆∞ - FinTrack</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>üí∞ FinTrack</h2>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/rentals.html" class="nav-item">
                    <span class="icon">üè†</span>
                    <span>Thu√™ ph√≤ng</span>
                </a>
                <a href="/salaries.html" class="nav-item">
                    <span class="icon">üíµ</span>
                    <span>L∆∞∆°ng</span>
                </a>
                <a href="/expenses.html" class="nav-item">
                    <span class="icon">üí≥</span>
                    <span>Chi ti√™u</span>
                </a>
                <a href="/savings.html" class="nav-item">
                    <span class="icon">üè¶</span>
                    <span>Ti·∫øt ki·ªám</span>
                </a>
                <a href="/deposits.html" class="nav-item active">
                    <span class="icon">üí∞</span>
                    <span>ƒê·∫ßu t∆∞</span>
                </a>
                <a href="/recurring-bills.html" class="nav-item">
                    <span class="icon">üìã</span>
                    <span>H√≥a ƒë∆°n</span>
                </a>
                <a href="/excel.html" class="nav-item">
                    <span class="icon">üìÅ</span>
                    <span>Excel Import/Export</span>
                </a>
                <a href="/settings.html" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
            </nav>
        </aside>
        <main class="main-content">
            <header class="top-bar">
                <h1>S·ªï Ti·∫øt Ki·ªám / ƒê·∫ßu T∆∞</h1>
                <div class="user-info">
                    <span id="user-name">User</span>
                    <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>
            <div class="content">

        <div class="stats-grid">
            <div class="stat-card">
                <h3>T·ªïng G·ªëc</h3>
                <p class="stat-value" id="totalPrincipal">0 VNƒê</p>
            </div>
            <div class="stat-card">
                <h3>T·ªïng L√£i</h3>
                <p class="stat-value" id="totalInterest">0 VNƒê</p>
            </div>
            <div class="stat-card">
                <h3>T·ªïng C·ªông</h3>
                <p class="stat-value" id="totalAmount">0 VNƒê</p>
            </div>
            <div class="stat-card">
                <h3>L√£i Su·∫•t TB</h3>
                <p class="stat-value" id="avgRate">0%</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Danh S√°ch S·ªï Ti·∫øt Ki·ªám</h2>
                <button class="btn btn-primary" onclick="showAddDepositForm()">+ Th√™m S·ªï</button>
            </div>
            <div class="card-body">
                <div class="filters">
                    <input type="text" id="bankFilter" placeholder="L·ªçc theo ng√¢n h√†ng" onchange="filterDeposits()">
                    <select id="statusFilter" onchange="filterDeposits()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="matured">ƒê√£ ƒë·∫øn h·∫°n</option>
                        <option value="closed">ƒê√£ ƒë√≥ng</option>
                    </select>
                </div>

                <div id="depositsList" class="table-responsive">
                    <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>üîî S·∫Øp ƒê√°o H·∫°n (30 ng√†y)</h2>
            </div>
            <div class="card-body">
                <div id="upcomingDeposits" class="table-responsive">
                    <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Deposit Modal -->
    <div id="depositModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeDepositModal()">&times;</span>
            <h2 id="modalTitle">Th√™m S·ªï Ti·∫øt Ki·ªám</h2>
            <form id="depositForm">
                <input type="hidden" id="depositId">
                
                <div class="form-group">
                    <label for="bank">Ng√¢n h√†ng *</label>
                    <input type="text" id="bank" required>
                </div>

                <div class="form-group">
                    <label for="accountType">Lo·∫°i t√†i kho·∫£n</label>
                    <input type="text" id="accountType">
                </div>

                <div class="form-group">
                    <label for="accountNumber">S·ªë t√†i kho·∫£n *</label>
                    <input type="text" id="accountNumber" required>
                </div>

                <div class="form-group">
                    <label for="accountName">T√™n t√†i kho·∫£n</label>
                    <input type="text" id="accountName">
                </div>

                <div class="form-group">
                    <label for="fundType">Lo·∫°i qu·ªπ</label>
                    <input type="text" id="fundType">
                </div>

                <div class="form-group">
                    <label for="principalAmount">S·ªë ti·ªÅn g·ªëc *</label>
                    <input type="number" id="principalAmount" required min="0">
                </div>

                <div class="form-group">
                    <label for="interestRate">L√£i su·∫•t (%/nƒÉm) *</label>
                    <input type="number" id="interestRate" required min="0" step="0.01">
                </div>

                <div class="form-group">
                    <label for="termMonths">K·ª≥ h·∫°n (th√°ng)</label>
                    <input type="number" id="termMonths" min="0">
                </div>

                <div class="form-group">
                    <label for="startDate">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="startDate">
                </div>

                <div class="form-group">
                    <label for="maturityDate">Ng√†y ƒë√°o h·∫°n</label>
                    <input type="date" id="maturityDate">
                </div>

                <div class="form-group">
                    <label for="interestAmount">S·ªë ti·ªÅn l√£i d·ª± ki·∫øn</label>
                    <input type="number" id="interestAmount" min="0">
                </div>

                <div class="form-group">
                    <label for="status">Tr·∫°ng th√°i</label>
                    <select id="status">
                        <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="matured">ƒê√£ ƒë·∫øn h·∫°n</option>
                        <option value="closed">ƒê√£ ƒë√≥ng</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">Ghi ch√∫</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDepositModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let deposits = [];
        let token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/index.html';
        }

        async function loadDeposits() {
            try {
                const bankFilter = document.getElementById('bankFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                let url = '/api/deposits?limit=100';
                if (bankFilter) url += `&bank=${encodeURIComponent(bankFilter)}`;
                if (statusFilter) url += `&status=${statusFilter}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    deposits = data.data;
                    displayDeposits(deposits);
                }
            } catch (error) {
                console.error('Error loading deposits:', error);
            }
        }

        function displayDeposits(depositsData) {
            const container = document.getElementById('depositsList');
            
            if (depositsData.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ s·ªï ti·∫øt ki·ªám n√†o.</p>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Ng√¢n h√†ng</th>
                            <th>S·ªë TK</th>
                            <th>S·ªë ti·ªÅn g·ªëc</th>
                            <th>L√£i su·∫•t</th>
                            <th>K·ª≥ h·∫°n</th>
                            <th>Ng√†y ƒë√°o h·∫°n</th>
                            <th>L√£i d·ª± ki·∫øn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${depositsData.map(deposit => `
                            <tr>
                                <td>${deposit.bank}</td>
                                <td>${deposit.accountNumber}</td>
                                <td>${deposit.principalAmount.toLocaleString('vi-VN')} VNƒê</td>
                                <td>${deposit.interestRate}%</td>
                                <td>${deposit.termMonths || 0} th√°ng</td>
                                <td>${deposit.maturityDate ? new Date(deposit.maturityDate).toLocaleDateString('vi-VN') : 'N/A'}</td>
                                <td>${deposit.interestAmount.toLocaleString('vi-VN')} VNƒê</td>
                                <td><span class="badge ${getStatusClass(deposit.status)}">${getStatusLabel(deposit.status)}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="editDeposit('${deposit._id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteDeposit('${deposit._id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        async function loadUpcomingDeposits() {
            try {
                const response = await fetch('/api/deposits/upcoming?days=30', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    displayUpcomingDeposits(data.data);
                }
            } catch (error) {
                console.error('Error loading upcoming deposits:', error);
            }
        }

        function displayUpcomingDeposits(depositsData) {
            const container = document.getElementById('upcomingDeposits');
            
            if (depositsData.length === 0) {
                container.innerHTML = '<p>Kh√¥ng c√≥ s·ªï n√†o s·∫Øp ƒë√°o h·∫°n.</p>';
                return;
            }

            const list = depositsData.map(deposit => `
                <div class="alert alert-info">
                    <strong>${deposit.bank}</strong> - ${deposit.accountNumber}
                    <br>G·ªëc: ${deposit.principalAmount.toLocaleString('vi-VN')} VNƒê | L√£i: ${deposit.interestAmount.toLocaleString('vi-VN')} VNƒê
                    <br>ƒê√°o h·∫°n: ${new Date(deposit.maturityDate).toLocaleDateString('vi-VN')}
                </div>
            `).join('');
            
            container.innerHTML = list;
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/deposits/stats/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.data.total) {
                    document.getElementById('totalPrincipal').textContent = 
                        (data.data.total.totalPrincipal || 0).toLocaleString('vi-VN') + ' VNƒê';
                    document.getElementById('totalInterest').textContent = 
                        (data.data.total.totalInterest || 0).toLocaleString('vi-VN') + ' VNƒê';
                    document.getElementById('totalAmount').textContent = 
                        (data.data.total.totalAmount || 0).toLocaleString('vi-VN') + ' VNƒê';
                    document.getElementById('avgRate').textContent = 
                        (data.data.total.avgInterestRate || 0).toFixed(2) + '%';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Ho·∫°t ƒë·ªông',
                'matured': 'ƒê√£ ƒë·∫øn h·∫°n',
                'closed': 'ƒê√£ ƒë√≥ng'
            };
            return labels[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'badge-success',
                'matured': 'badge-warning',
                'closed': 'badge-secondary'
            };
            return classes[status] || 'badge-secondary';
        }

        function filterDeposits() {
            loadDeposits();
        }

        function showAddDepositForm() {
            document.getElementById('modalTitle').textContent = 'Th√™m S·ªï Ti·∫øt Ki·ªám';
            document.getElementById('depositForm').reset();
            document.getElementById('depositId').value = '';
            document.getElementById('status').value = 'active';
            document.getElementById('depositModal').style.display = 'block';
        }

        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }

        async function editDeposit(id) {
            const deposit = deposits.find(d => d._id === id);
            if (!deposit) return;

            document.getElementById('modalTitle').textContent = 'Ch·ªânh S·ª≠a S·ªï Ti·∫øt Ki·ªám';
            document.getElementById('depositId').value = deposit._id;
            document.getElementById('bank').value = deposit.bank;
            document.getElementById('accountType').value = deposit.accountType || '';
            document.getElementById('accountNumber').value = deposit.accountNumber;
            document.getElementById('accountName').value = deposit.accountName || '';
            document.getElementById('fundType').value = deposit.fundType || '';
            document.getElementById('principalAmount').value = deposit.principalAmount;
            document.getElementById('interestRate').value = deposit.interestRate;
            document.getElementById('termMonths').value = deposit.termMonths || '';
            document.getElementById('startDate').value = deposit.startDate ? deposit.startDate.split('T')[0] : '';
            document.getElementById('maturityDate').value = deposit.maturityDate ? deposit.maturityDate.split('T')[0] : '';
            document.getElementById('interestAmount').value = deposit.interestAmount || '';
            document.getElementById('status').value = deposit.status;
            document.getElementById('notes').value = deposit.notes || '';
            document.getElementById('depositModal').style.display = 'block';
        }

        async function deleteDeposit(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ªï ti·∫øt ki·ªám n√†y?')) return;

            try {
                const response = await fetch(`/api/deposits/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    alert('X√≥a s·ªï ti·∫øt ki·ªám th√†nh c√¥ng!');
                    loadDeposits();
                    loadStats();
                }
            } catch (error) {
                console.error('Error deleting deposit:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const depositId = document.getElementById('depositId').value;
            const depositData = {
                bank: document.getElementById('bank').value,
                accountType: document.getElementById('accountType').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountName: document.getElementById('accountName').value,
                fundType: document.getElementById('fundType').value,
                principalAmount: parseFloat(document.getElementById('principalAmount').value),
                interestRate: parseFloat(document.getElementById('interestRate').value),
                termMonths: parseInt(document.getElementById('termMonths').value) || 0,
                startDate: document.getElementById('startDate').value || undefined,
                maturityDate: document.getElementById('maturityDate').value || undefined,
                interestAmount: parseFloat(document.getElementById('interestAmount').value) || 0,
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value
            };

            try {
                const url = depositId ? `/api/deposits/${depositId}` : '/api/deposits';
                const method = depositId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(depositData)
                });

                const data = await response.json();
                if (data.success) {
                    alert(depositId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m s·ªï ti·∫øt ki·ªám th√†nh c√¥ng!');
                    closeDepositModal();
                    loadDeposits();
                    loadUpcomingDeposits();
                    loadStats();
                }
            } catch (error) {
                console.error('Error saving deposit:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }

        // Initial load
        loadDeposits();
        loadUpcomingDeposits();
        loadStats();
    </script>
</body>
</html>
