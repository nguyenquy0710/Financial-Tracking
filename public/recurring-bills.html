<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√≥a ƒê∆°n ƒê·ªãnh K·ª≥ - FinTrack</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>üí∞ FinTrack</h2>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/rentals.html" class="nav-item">
                    <span class="icon">üè†</span>
                    <span>Thu√™ ph√≤ng</span>
                </a>
                <a href="/salaries.html" class="nav-item">
                    <span class="icon">üíµ</span>
                    <span>L∆∞∆°ng</span>
                </a>
                <a href="/expenses.html" class="nav-item">
                    <span class="icon">üí≥</span>
                    <span>Chi ti√™u</span>
                </a>
                <a href="/savings.html" class="nav-item">
                    <span class="icon">üè¶</span>
                    <span>Ti·∫øt ki·ªám</span>
                </a>
                <a href="/deposits.html" class="nav-item">
                    <span class="icon">üí∞</span>
                    <span>ƒê·∫ßu t∆∞</span>
                </a>
                <a href="/recurring-bills.html" class="nav-item active">
                    <span class="icon">üìã</span>
                    <span>H√≥a ƒë∆°n</span>
                </a>
                <a href="/excel.html" class="nav-item">
                    <span class="icon">üìÅ</span>
                    <span>Excel Import/Export</span>
                </a>
                <a href="/settings.html" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
            </nav>
        </aside>
        <main class="main-content">
            <header class="top-bar">
                <h1>H√≥a ƒê∆°n ƒê·ªãnh K·ª≥</h1>
                <div class="user-info">
                    <span id="user-name">User</span>
                    <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>
            <div class="content">

        <div class="stats-grid">
            <div class="stat-card">
                <h3>T·ªïng H√≥a ƒê∆°n Th√°ng</h3>
                <p class="stat-value" id="totalMonthly">0 VNƒê</p>
            </div>
            <div class="stat-card">
                <h3>S·∫Øp ƒê·∫øn H·∫°n</h3>
                <p class="stat-value" id="upcomingCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Qu√° H·∫°n</h3>
                <p class="stat-value" id="overdueCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Ho·∫°t ƒê·ªông</h3>
                <p class="stat-value" id="activeCount">0</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Danh S√°ch H√≥a ƒê∆°n</h2>
                <button class="btn btn-primary" onclick="showAddBillForm()">+ Th√™m H√≥a ƒê∆°n</button>
            </div>
            <div class="card-body">
                <div class="filters">
                    <select id="typeFilter" onchange="filterBills()">
                        <option value="">T·∫•t c·∫£ lo·∫°i</option>
                        <option value="rent">Ti·ªÅn nh√†</option>
                        <option value="electricity">ƒêi·ªán</option>
                        <option value="water">N∆∞·ªõc</option>
                        <option value="internet">Internet</option>
                        <option value="parking">G·ª≠i xe</option>
                        <option value="garbage">R√°c</option>
                        <option value="other">Kh√°c</option>
                    </select>
                    <select id="statusFilter" onchange="filterBills()">
                        <option value="true">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="false">ƒê√£ d·ª´ng</option>
                        <option value="">T·∫•t c·∫£</option>
                    </select>
                </div>

                <div id="billsList" class="table-responsive">
                    <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>üîî S·∫Øp ƒê·∫øn H·∫°n (7 ng√†y)</h2>
            </div>
            <div class="card-body">
                <div id="upcomingBills" class="table-responsive">
                    <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Bill Modal -->
    <div id="billModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeBillModal()">&times;</span>
            <h2 id="modalTitle">Th√™m H√≥a ƒê∆°n ƒê·ªãnh K·ª≥</h2>
            <form id="billForm">
                <input type="hidden" id="billId">
                
                <div class="form-group">
                    <label for="name">T√™n h√≥a ƒë∆°n *</label>
                    <input type="text" id="name" required>
                </div>

                <div class="form-group">
                    <label for="type">Lo·∫°i *</label>
                    <select id="type" required>
                        <option value="rent">Ti·ªÅn nh√†</option>
                        <option value="electricity">ƒêi·ªán</option>
                        <option value="water">N∆∞·ªõc</option>
                        <option value="internet">Internet</option>
                        <option value="parking">G·ª≠i xe</option>
                        <option value="garbage">R√°c</option>
                        <option value="other">Kh√°c</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="amount">S·ªë ti·ªÅn *</label>
                    <input type="number" id="amount" required min="0">
                </div>

                <div class="form-group">
                    <label for="frequency">T·∫ßn su·∫•t *</label>
                    <select id="frequency" required>
                        <option value="monthly">H√†ng th√°ng</option>
                        <option value="weekly">H√†ng tu·∫ßn</option>
                        <option value="quarterly">H√†ng qu√Ω</option>
                        <option value="yearly">H√†ng nƒÉm</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dueDay">Ng√†y ƒë·∫øn h·∫°n (1-31)</label>
                    <input type="number" id="dueDay" min="1" max="31">
                </div>

                <div class="form-group">
                    <label for="nextDueDate">Ng√†y ƒë·∫øn h·∫°n ti·∫øp theo *</label>
                    <input type="date" id="nextDueDate" required>
                </div>

                <div class="form-group">
                    <label for="reminderDays">Nh·∫Øc nh·ªü tr∆∞·ªõc (ng√†y)</label>
                    <input type="number" id="reminderDays" value="3" min="0">
                </div>

                <div class="form-group">
                    <label for="autoDebit">
                        <input type="checkbox" id="autoDebit">
                        T·ª± ƒë·ªông thanh to√°n
                    </label>
                </div>

                <div class="form-group">
                    <label for="notes">Ghi ch√∫</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBillModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let bills = [];
        let token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/index.html';
        }

        async function loadBills() {
            try {
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                let url = '/api/recurring-bills?limit=100';
                if (typeFilter) url += `&type=${typeFilter}`;
                if (statusFilter) url += `&isActive=${statusFilter}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    bills = data.data;
                    displayBills(bills);
                }
            } catch (error) {
                console.error('Error loading bills:', error);
            }
        }

        function displayBills(billsData) {
            const container = document.getElementById('billsList');
            
            if (billsData.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</p>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>T√™n</th>
                            <th>Lo·∫°i</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>T·∫ßn su·∫•t</th>
                            <th>Ng√†y ƒë·∫øn h·∫°n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${billsData.map(bill => `
                            <tr>
                                <td>${bill.name}</td>
                                <td>${getTypeLabel(bill.type)}</td>
                                <td>${bill.amount.toLocaleString('vi-VN')} VNƒê</td>
                                <td>${getFrequencyLabel(bill.frequency)}</td>
                                <td>${new Date(bill.nextDueDate).toLocaleDateString('vi-VN')}</td>
                                <td><span class="badge ${bill.isActive ? 'badge-success' : 'badge-secondary'}">${bill.isActive ? 'Ho·∫°t ƒë·ªông' : 'D·ª´ng'}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="markAsPaid('${bill._id}')">‚úì ƒê√£ thanh to√°n</button>
                                    <button class="btn btn-sm" onclick="editBill('${bill._id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBill('${bill._id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        async function loadUpcomingBills() {
            try {
                const response = await fetch('/api/recurring-bills/upcoming?days=7', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    displayUpcomingBills(data.data);
                }
            } catch (error) {
                console.error('Error loading upcoming bills:', error);
            }
        }

        function displayUpcomingBills(billsData) {
            const container = document.getElementById('upcomingBills');
            
            if (billsData.length === 0) {
                container.innerHTML = '<p>Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o s·∫Øp ƒë·∫øn h·∫°n.</p>';
                return;
            }

            const list = billsData.map(bill => `
                <div class="alert alert-warning">
                    <strong>${bill.name}</strong> - ${bill.amount.toLocaleString('vi-VN')} VNƒê
                    <br>ƒê·∫øn h·∫°n: ${new Date(bill.nextDueDate).toLocaleDateString('vi-VN')}
                    <button class="btn btn-sm" onclick="markAsPaid('${bill._id}')">‚úì ƒê√£ thanh to√°n</button>
                </div>
            `).join('');
            
            container.innerHTML = list;
        }

        async function loadStats() {
            try {
                const [statsRes, upcomingRes, overdueRes] = await Promise.all([
                    fetch('/api/recurring-bills/stats/summary', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/recurring-bills/upcoming?days=7', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/recurring-bills/overdue', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const statsData = await statsRes.json();
                const upcomingData = await upcomingRes.json();
                const overdueData = await overdueRes.json();

                if (statsData.success) {
                    document.getElementById('totalMonthly').textContent = 
                        (statsData.data.monthlyTotal.total || 0).toLocaleString('vi-VN') + ' VNƒê';
                }

                if (upcomingData.success) {
                    document.getElementById('upcomingCount').textContent = upcomingData.count || 0;
                }

                if (overdueData.success) {
                    document.getElementById('overdueCount').textContent = overdueData.count || 0;
                }

                const activeResponse = await fetch('/api/recurring-bills?isActive=true&limit=1000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const activeData = await activeResponse.json();
                if (activeData.success) {
                    document.getElementById('activeCount').textContent = activeData.data.length;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function getTypeLabel(type) {
            const labels = {
                'rent': 'Ti·ªÅn nh√†',
                'electricity': 'ƒêi·ªán',
                'water': 'N∆∞·ªõc',
                'internet': 'Internet',
                'parking': 'G·ª≠i xe',
                'garbage': 'R√°c',
                'other': 'Kh√°c'
            };
            return labels[type] || type;
        }

        function getFrequencyLabel(frequency) {
            const labels = {
                'daily': 'H√†ng ng√†y',
                'weekly': 'H√†ng tu·∫ßn',
                'monthly': 'H√†ng th√°ng',
                'quarterly': 'H√†ng qu√Ω',
                'yearly': 'H√†ng nƒÉm'
            };
            return labels[frequency] || frequency;
        }

        function filterBills() {
            loadBills();
        }

        function showAddBillForm() {
            document.getElementById('modalTitle').textContent = 'Th√™m H√≥a ƒê∆°n ƒê·ªãnh K·ª≥';
            document.getElementById('billForm').reset();
            document.getElementById('billId').value = '';
            document.getElementById('billModal').style.display = 'block';
        }

        function closeBillModal() {
            document.getElementById('billModal').style.display = 'none';
        }

        async function editBill(id) {
            const bill = bills.find(b => b._id === id);
            if (!bill) return;

            document.getElementById('modalTitle').textContent = 'Ch·ªânh S·ª≠a H√≥a ƒê∆°n';
            document.getElementById('billId').value = bill._id;
            document.getElementById('name').value = bill.name;
            document.getElementById('type').value = bill.type;
            document.getElementById('amount').value = bill.amount;
            document.getElementById('frequency').value = bill.frequency;
            document.getElementById('dueDay').value = bill.dueDay || '';
            document.getElementById('nextDueDate').value = bill.nextDueDate.split('T')[0];
            document.getElementById('reminderDays').value = bill.reminderDays;
            document.getElementById('autoDebit').checked = bill.autoDebit;
            document.getElementById('notes').value = bill.notes || '';
            document.getElementById('billModal').style.display = 'block';
        }

        async function deleteBill(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y?')) return;

            try {
                const response = await fetch(`/api/recurring-bills/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    alert('X√≥a h√≥a ƒë∆°n th√†nh c√¥ng!');
                    loadBills();
                    loadStats();
                }
            } catch (error) {
                console.error('Error deleting bill:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        }

        async function markAsPaid(id) {
            const amount = prompt('Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thanh to√°n:');
            if (!amount) return;

            try {
                const response = await fetch(`/api/recurring-bills/${id}/pay`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        paidDate: new Date().toISOString()
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ƒê√£ ƒë√°nh d·∫•u thanh to√°n!');
                    loadBills();
                    loadUpcomingBills();
                    loadStats();
                }
            } catch (error) {
                console.error('Error marking as paid:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        }

        document.getElementById('billForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const billId = document.getElementById('billId').value;
            const billData = {
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                frequency: document.getElementById('frequency').value,
                dueDay: parseInt(document.getElementById('dueDay').value) || undefined,
                nextDueDate: document.getElementById('nextDueDate').value,
                reminderDays: parseInt(document.getElementById('reminderDays').value),
                autoDebit: document.getElementById('autoDebit').checked,
                notes: document.getElementById('notes').value
            };

            try {
                const url = billId ? `/api/recurring-bills/${billId}` : '/api/recurring-bills';
                const method = billId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(billData)
                });

                const data = await response.json();
                if (data.success) {
                    alert(billId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m h√≥a ƒë∆°n th√†nh c√¥ng!');
                    closeBillModal();
                    loadBills();
                    loadStats();
                }
            } catch (error) {
                console.error('Error saving bill:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        });

        // Initial load
        loadBills();
        loadUpcomingBills();
        loadStats();
    </script>
</body>
</html>
