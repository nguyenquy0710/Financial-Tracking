<!DOCTYPE html>
<html lang="vi">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ti·∫øt ki·ªám - FinTrack</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
  </head>

  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="logo">
          <h2>üí∞ FinTrack</h2>
        </div>
        <nav class="nav-menu">
          <a href="/dashboard.html" class="nav-item">
            <span class="icon">üìä</span>
            <span>Dashboard</span>
          </a>
          <a href="/rentals.html" class="nav-item">
            <span class="icon">üè†</span>
            <span>Thu√™ ph√≤ng</span>
          </a>
          <a href="/salaries.html" class="nav-item">
            <span class="icon">üíµ</span>
            <span>L∆∞∆°ng</span>
          </a>
          <a href="/expenses.html" class="nav-item">
            <span class="icon">üí≥</span>
            <span>Chi ti√™u</span>
          </a>
          <a href="/savings.html" class="nav-item active">
            <span class="icon">üè¶</span>
            <span>Ti·∫øt ki·ªám</span>
          </a>
          <a href="/deposits.html" class="nav-item">
            <span class="icon">üí∞</span>
            <span>ƒê·∫ßu t∆∞</span>
          </a>
          <a href="/recurring-bills.html" class="nav-item">
            <span class="icon">üìã</span>
            <span>H√≥a ƒë∆°n</span>
          </a>
          <a href="/excel.html" class="nav-item">
            <span class="icon">üìÅ</span>
            <span>Excel Import/Export</span>
          </a>
          <a href="/settings.html" class="nav-item">
            <span class="icon">‚öôÔ∏è</span>
            <span>C√†i ƒë·∫∑t</span>
          </a>
        </nav>
      </aside>
      <main class="main-content">
        <header class="top-bar">
          <h1>Qu·∫£n l√Ω ti·∫øt ki·ªám</h1>
          <div class="user-info">
            <span id="user-name">User</span>
            <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
          </div>
        </header>
        <div class="content">
          <div class="stats-grid">
            <div class="stat-card">
              <h3>G·ª≠i M·∫π</h3>
              <p class="stat-value" id="totalMother">0 VNƒê</p>
            </div>
            <div class="stat-card">
              <h3>G·ª≠i Qu·ªπ</h3>
              <p class="stat-value" id="totalFund">0 VNƒê</p>
            </div>
            <div class="stat-card">
              <h3>T·ªïng C·ªông</h3>
              <p class="stat-value" id="totalSavings">0 VNƒê</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Danh S√°ch Ti·∫øt Ki·ªám</h2>
              <button class="btn btn-primary" onclick="showAddSavingForm()">+ Th√™m Ti·∫øt Ki·ªám</button>
            </div>
            <div class="card-body">
              <div class="filters">
                <select id="typeFilter" onchange="filterSavings()">
                  <option value="">T·∫•t c·∫£ lo·∫°i</option>
                  <option value="mother">G·ª≠i M·∫π</option>
                  <option value="fund">G·ª≠i Qu·ªπ</option>
                </select>
                <input type="month" id="monthFilter" onchange="filterSavings()">
              </div>
              <div id="savingsList" class="table-responsive">
                <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Saving Modal -->
    <div id="savingModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeSavingModal()">&times;</span>
        <h2 id="modalTitle">Th√™m Ti·∫øt Ki·ªám</h2>
        <form id="savingForm">
          <input type="hidden" id="savingId">

          <div class="form-group">
            <label for="month">Th√°ng *</label>
            <input type="month" id="month" required>
          </div>

          <div class="form-group">
            <label for="type">Lo·∫°i *</label>
            <select id="type" required>
              <option value="mother">G·ª≠i M·∫π</option>
              <option value="fund">G·ª≠i Qu·ªπ</option>
            </select>
          </div>

          <div class="form-group">
            <label for="depositDate">Ng√†y g·ª≠i *</label>
            <input type="date" id="depositDate" required>
          </div>

          <div class="form-group">
            <label for="amount">S·ªë ti·ªÅn *</label>
            <input type="number" id="amount" required min="0">
          </div>

          <div class="form-group">
            <label for="accountNumber">S·ªë t√†i kho·∫£n</label>
            <input type="text" id="accountNumber">
          </div>

          <div class="form-group">
            <label for="recipient">Ng∆∞·ªùi nh·∫≠n</label>
            <input type="text" id="recipient">
          </div>

          <div class="form-group">
            <label for="notes">Ghi ch√∫</label>
            <textarea id="notes" rows="3"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeSavingModal()">H·ªßy</button>
            <button type="submit" class="btn btn-primary">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
      let savings = [];
      let token = localStorage.getItem('token');

      if (!token) {
        window.location.href = '/index.html';
      }

      async function loadSavings() {
        try {
          const typeFilter = document.getElementById('typeFilter').value;
          const monthFilter = document.getElementById('monthFilter').value;

          let url = '/api/savings?limit=100';
          if (typeFilter) url += `&type=${typeFilter}`;
          if (monthFilter) {
            const startDate = new Date(monthFilter + '-01').toISOString();
            const endMonth = new Date(monthFilter);
            endMonth.setMonth(endMonth.getMonth() + 1);
            const endDate = new Date(endMonth).toISOString();
            url += `&startDate=${startDate}&endDate=${endDate}`;
          }

          const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();

          if (data.success) {
            savings = data.data;
            displaySavings(savings);
          }
        } catch (error) {
          console.error('Error loading savings:', error);
        }
      }

      function displaySavings(savingsData) {
        const container = document.getElementById('savingsList');

        if (savingsData.length === 0) {
          container.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu ti·∫øt ki·ªám.</p>';
          return;
        }

        const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Th√°ng</th>
                            <th>Lo·∫°i</th>
                            <th>Ng√†y g·ª≠i</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>Ng∆∞·ªùi nh·∫≠n</th>
                            <th>Ghi ch√∫</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${savingsData.map(saving => `
                            <tr>
                                <td>${new Date(saving.month).toLocaleDateString('vi-VN', { year: 'numeric', month: '2-digit' })}</td>
                                <td>${saving.type === 'mother' ? 'G·ª≠i M·∫π' : 'G·ª≠i Qu·ªπ'}</td>
                                <td>${new Date(saving.depositDate).toLocaleDateString('vi-VN')}</td>
                                <td>${saving.amount.toLocaleString('vi-VN')} VNƒê</td>
                                <td>${saving.recipient || 'N/A'}</td>
                                <td>${saving.notes || ''}</td>
                                <td>
                                    <button class="btn btn-sm" onclick="editSaving('${saving._id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSaving('${saving._id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

        container.innerHTML = table;
      }

      async function loadStats() {
        try {
          const response = await fetch('/api/savings/stats/summary', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();

          if (data.success) {
            const byType = data.data.byType;
            const motherData = byType.find(item => item._id === 'mother');
            const fundData = byType.find(item => item._id === 'fund');

            document.getElementById('totalMother').textContent =
              (motherData?.totalAmount || 0).toLocaleString('vi-VN') + ' VNƒê';
            document.getElementById('totalFund').textContent =
              (fundData?.totalAmount || 0).toLocaleString('vi-VN') + ' VNƒê';
            document.getElementById('totalSavings').textContent =
              (data.data.total.total || 0).toLocaleString('vi-VN') + ' VNƒê';
          }
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      function filterSavings() {
        loadSavings();
      }

      function showAddSavingForm() {
        document.getElementById('modalTitle').textContent = 'Th√™m Ti·∫øt Ki·ªám';
        document.getElementById('savingForm').reset();
        document.getElementById('savingId').value = '';
        document.getElementById('savingModal').style.display = 'block';
      }

      function closeSavingModal() {
        document.getElementById('savingModal').style.display = 'none';
      }

      async function editSaving(id) {
        const saving = savings.find(s => s._id === id);
        if (!saving) return;

        document.getElementById('modalTitle').textContent = 'Ch·ªânh S·ª≠a Ti·∫øt Ki·ªám';
        document.getElementById('savingId').value = saving._id;
        document.getElementById('month').value = saving.month.split('T')[0].substring(0, 7);
        document.getElementById('type').value = saving.type;
        document.getElementById('depositDate').value = saving.depositDate.split('T')[0];
        document.getElementById('amount').value = saving.amount;
        document.getElementById('accountNumber').value = saving.accountNumber || '';
        document.getElementById('recipient').value = saving.recipient || '';
        document.getElementById('notes').value = saving.notes || '';
        document.getElementById('savingModal').style.display = 'block';
      }

      async function deleteSaving(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n ti·∫øt ki·ªám n√†y?')) return;

        try {
          const response = await fetch(`/api/savings/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });

          const data = await response.json();
          if (data.success) {
            alert('X√≥a th√†nh c√¥ng!');
            loadSavings();
            loadStats();
          }
        } catch (error) {
          console.error('Error deleting saving:', error);
          alert('C√≥ l·ªói x·∫£y ra!');
        }
      }

      document.getElementById('savingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const savingId = document.getElementById('savingId').value;
        const savingData = {
          month: document.getElementById('month').value + '-01',
          type: document.getElementById('type').value,
          depositDate: document.getElementById('depositDate').value,
          amount: parseFloat(document.getElementById('amount').value),
          accountNumber: document.getElementById('accountNumber').value,
          recipient: document.getElementById('recipient').value,
          notes: document.getElementById('notes').value
        };

        try {
          const url = savingId ? `/api/savings/${savingId}` : '/api/savings';
          const method = savingId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(savingData)
          });

          const data = await response.json();
          if (data.success) {
            alert(savingId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m ti·∫øt ki·ªám th√†nh c√¥ng!');
            closeSavingModal();
            loadSavings();
            loadStats();
          }
        } catch (error) {
          console.error('Error saving:', error);
          alert('C√≥ l·ªói x·∫£y ra!');
        }
      });

      // Initial load
      loadSavings();
      loadStats();
    </script>
  </body>

</html>
