<!DOCTYPE html>
<html lang="vi">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thu√™ ph√≤ng - FinTrack</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
  </head>

  <body>
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <div class="logo">
          <h2>üí∞ FinTrack</h2>
        </div>
        <nav class="nav-menu">
          <a href="/dashboard.html" class="nav-item">
            <span class="icon">üìä</span>
            <span>Dashboard</span>
          </a>
          <a href="/rentals.html" class="nav-item active">
            <span class="icon">üè†</span>
            <span>Thu√™ ph√≤ng</span>
          </a>
          <a href="/salaries.html" class="nav-item">
            <span class="icon">üíµ</span>
            <span>L∆∞∆°ng</span>
          </a>
          <a href="/expenses.html" class="nav-item">
            <span class="icon">üí≥</span>
            <span>Chi ti√™u</span>
          </a>
          <a href="/savings.html" class="nav-item">
            <span class="icon">üè¶</span>
            <span>Ti·∫øt ki·ªám</span>
          </a>
          <a href="/excel.html" class="nav-item">
            <span class="icon">üìÅ</span>
            <span>Excel Import/Export</span>
          </a>
          <a href="/settings.html" class="nav-item">
            <span class="icon">‚öôÔ∏è</span>
            <span>C√†i ƒë·∫∑t</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <h1>Qu·∫£n l√Ω thu√™ ph√≤ng</h1>
          <div class="user-info">
            <span id="user-name">User</span>
            <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
          </div>
        </header>

        <div class="content">
          <!-- Summary Cards -->
          <div class="summary-grid">
            <div class="summary-card">
              <div class="card-icon">üè†</div>
              <div class="card-content">
                <h3>T·ªïng ti·ªÅn thu√™</h3>
                <p class="amount" id="total-rent">0 VND</p>
                <span class="period">Th√°ng n√†y</span>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon">‚ö°</div>
              <div class="card-content">
                <h3>Ti·ªÅn ƒëi·ªán</h3>
                <p class="amount" id="total-electricity">0 VND</p>
                <span class="period">Th√°ng n√†y</span>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon">üíß</div>
              <div class="card-content">
                <h3>Ti·ªÅn n∆∞·ªõc</h3>
                <p class="amount" id="total-water">0 VND</p>
                <span class="period">Th√°ng n√†y</span>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon">üì°</div>
              <div class="card-content">
                <h3>D·ªãch v·ª• kh√°c</h3>
                <p class="amount" id="total-services">0 VND</p>
                <span class="period">Th√°ng n√†y</span>
              </div>
            </div>
          </div>

          <!-- Rentals List -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>Danh s√°ch thu√™ ph√≤ng</h2>
              <button class="btn btn-primary" onclick="showAddModal()">
                <span class="icon">‚ûï</span> Th√™m m·ªõi
              </button>
            </div>

            <div id="rentals-list" class="table-container">
              <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="/js/auth.js"></script>
    <script>
      // Load rentals data
      document.addEventListener('DOMContentLoaded', async () => {
        await loadRentals();
      });

      const loadRentals = async () => {
        const container = document.getElementById('rentals-list');
        container.innerHTML = '<p class="loading">ƒêang t·∫£i...</p>';

        try {
          const response = await apiCall('/rentals');

          if (response.success && response.data) {
            if (response.data.length === 0) {
              container.innerHTML = '<p class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng import t·ª´ Excel ho·∫∑c th√™m m·ªõi.</p>';
              return;
            }

            // Calculate totals
            let totalRent = 0, totalElectricity = 0, totalWater = 0, totalServices = 0;

            response.data.forEach(rental => {
              totalRent += rental.rentAmount || 0;
              totalElectricity += rental.electricity?.amount || 0;
              totalWater += rental.water?.amount || 0;
              totalServices += (rental.internet || 0) + (rental.parking || 0) + (rental.garbage || 0);
            });

            document.getElementById('total-rent').textContent = formatCurrency(totalRent);
            document.getElementById('total-electricity').textContent = formatCurrency(totalElectricity);
            document.getElementById('total-water').textContent = formatCurrency(totalWater);
            document.getElementById('total-services').textContent = formatCurrency(totalServices);

            // Display rentals
            container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ph√≤ng</th>
                                    <th>Th√°ng</th>
                                    <th>Ti·ªÅn nh√†</th>
                                    <th>ƒêi·ªán</th>
                                    <th>N∆∞·ªõc</th>
                                    <th>Internet</th>
                                    <th>T·ªïng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${response.data.map(rental => `
                                    <tr>
                                        <td><strong>${rental.propertyName}</strong></td>
                                        <td>${new Date(rental.month).toLocaleDateString('vi-VN', { month: '2-digit', year: 'numeric' })}</td>
                                        <td>${formatCurrency(rental.rentAmount)}</td>
                                        <td>${formatCurrency(rental.electricity?.amount || 0)}</td>
                                        <td>${formatCurrency(rental.water?.amount || 0)}</td>
                                        <td>${formatCurrency(rental.internet || 0)}</td>
                                        <td><strong>${formatCurrency(rental.total)}</strong></td>
                                        <td>
                                            <span class="badge ${rental.isPaid ? 'badge-success' : 'badge-warning'}">
                                                ${rental.isPaid ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
          } else {
            container.innerHTML = '<p class="loading">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p>';
          }
        } catch (error) {
          console.error('Failed to load rentals:', error);
          container.innerHTML = '<p class="loading">L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. H√£y import d·ªØ li·ªáu t·ª´ Excel.</p>';
        }
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(amount);
      };

      const showAddModal = () => {
        alert('Ch·ª©c nƒÉng th√™m m·ªõi s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau. Hi·ªán t·∫°i vui l√≤ng s·ª≠ d·ª•ng Excel Import.');
      };
    </script>

    <style>
      .table-container {
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      .data-table th {
        background: #f5f7fa;
        font-weight: 600;
        color: #2c3e50;
      }

      .data-table tbody tr:hover {
        background: #f8f9fa;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge-success {
        background: #d4edda;
        color: #155724;
      }

      .badge-warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </body>

</html>
