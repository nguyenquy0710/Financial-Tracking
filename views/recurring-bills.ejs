<%- include('partials/header', { title: 'HÃ³a Ä‘Æ¡n Ä‘á»‹nh ká»³' , additionalCSS: ['/css/dashboard.css'] }) %>
  <div class="app-container">
    <aside class="sidebar">
      <div class="logo">
        <h2>ğŸ’° FinTrack</h2>
      </div>
      <nav class="nav-menu">
        <a href="/dashboard" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/rentals.html" class="nav-item">
          <span class="icon">ğŸ </span>
          <span>ThuÃª phÃ²ng</span>
        </a>
        <a href="/salaries.html" class="nav-item">
          <span class="icon">ğŸ’µ</span>
          <span>LÆ°Æ¡ng</span>
        </a>
        <a href="/expenses.html" class="nav-item">
          <span class="icon">ğŸ’³</span>
          <span>Chi tiÃªu</span>
        </a>
        <a href="/savings.html" class="nav-item">
          <span class="icon">ğŸ¦</span>
          <span>Tiáº¿t kiá»‡m</span>
        </a>
        <a href="/deposits.html" class="nav-item">
          <span class="icon">ğŸ’°</span>
          <span>Äáº§u tÆ°</span>
        </a>
        <a href="/recurring-bills.html" class="nav-item active">
          <span class="icon">ğŸ“‹</span>
          <span>HÃ³a Ä‘Æ¡n</span>
        </a>
        <a href="/excel.html" class="nav-item">
          <span class="icon">ğŸ“</span>
          <span>Excel Import/Export</span>
        </a>
        <a href="/settings.html" class="nav-item">
          <span class="icon">âš™ï¸</span>
          <span>CÃ i Ä‘áº·t</span>
        </a>
      </nav>
    </aside>
    <main class="main-content">
      <header class="top-bar">
        <h1>HÃ³a ÄÆ¡n Äá»‹nh Ká»³</h1>
        <div class="user-info">
          <span id="user-name">User</span>
          <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
        </div>
      </header>
      <div class="content">

        <div class="stats-grid">
          <div class="stat-card">
            <h3>Tá»•ng HÃ³a ÄÆ¡n ThÃ¡ng</h3>
            <p class="stat-value" id="totalMonthly">0 VNÄ</p>
          </div>
          <div class="stat-card">
            <h3>Sáº¯p Äáº¿n Háº¡n</h3>
            <p class="stat-value" id="upcomingCount">0</p>
          </div>
          <div class="stat-card">
            <h3>QuÃ¡ Háº¡n</h3>
            <p class="stat-value" id="overdueCount">0</p>
          </div>
          <div class="stat-card">
            <h3>Hoáº¡t Äá»™ng</h3>
            <p class="stat-value" id="activeCount">0</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Danh SÃ¡ch HÃ³a ÄÆ¡n</h2>
            <button class="btn btn-primary" onclick="showAddBillForm()">+ ThÃªm HÃ³a ÄÆ¡n</button>
          </div>
          <div class="card-body">
            <div class="filters">
              <select id="typeFilter" onchange="filterBills()">
                <option value="">Táº¥t cáº£ loáº¡i</option>
                <option value="rent">Tiá»n nhÃ </option>
                <option value="electricity">Äiá»‡n</option>
                <option value="water">NÆ°á»›c</option>
                <option value="internet">Internet</option>
                <option value="parking">Gá»­i xe</option>
                <option value="garbage">RÃ¡c</option>
                <option value="other">KhÃ¡c</option>
              </select>
              <select id="statusFilter" onchange="filterBills()">
                <option value="true">Äang hoáº¡t Ä‘á»™ng</option>
                <option value="false">ÄÃ£ dá»«ng</option>
                <option value="">Táº¥t cáº£</option>
              </select>
            </div>

            <div id="billsList" class="table-responsive">
              <p class="loading">Äang táº£i dá»¯ liá»‡u...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>ğŸ”” Sáº¯p Äáº¿n Háº¡n (7 ngÃ y)</h2>
          </div>
          <div class="card-body">
            <div id="upcomingBills" class="table-responsive">
              <p class="loading">Äang táº£i dá»¯ liá»‡u...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Bill Modal -->
  <div id="billModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeBillModal()">&times;</span>
      <h2 id="modalTitle">ThÃªm HÃ³a ÄÆ¡n Äá»‹nh Ká»³</h2>
      <form id="billForm">
        <input type="hidden" id="billId">

        <div class="form-group">
          <label for="name">TÃªn hÃ³a Ä‘Æ¡n *</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label for="type">Loáº¡i *</label>
          <select id="type" required>
            <option value="rent">Tiá»n nhÃ </option>
            <option value="electricity">Äiá»‡n</option>
            <option value="water">NÆ°á»›c</option>
            <option value="internet">Internet</option>
            <option value="parking">Gá»­i xe</option>
            <option value="garbage">RÃ¡c</option>
            <option value="other">KhÃ¡c</option>
          </select>
        </div>

        <div class="form-group">
          <label for="amount">Sá»‘ tiá»n *</label>
          <input type="number" id="amount" required min="0">
        </div>

        <div class="form-group">
          <label for="frequency">Táº§n suáº¥t *</label>
          <select id="frequency" required>
            <option value="monthly">HÃ ng thÃ¡ng</option>
            <option value="weekly">HÃ ng tuáº§n</option>
            <option value="quarterly">HÃ ng quÃ½</option>
            <option value="yearly">HÃ ng nÄƒm</option>
          </select>
        </div>

        <div class="form-group">
          <label for="dueDay">NgÃ y Ä‘áº¿n háº¡n (1-31)</label>
          <input type="number" id="dueDay" min="1" max="31">
        </div>

        <div class="form-group">
          <label for="nextDueDate">NgÃ y Ä‘áº¿n háº¡n tiáº¿p theo *</label>
          <input type="date" id="nextDueDate" required>
        </div>

        <div class="form-group">
          <label for="reminderDays">Nháº¯c nhá»Ÿ trÆ°á»›c (ngÃ y)</label>
          <input type="number" id="reminderDays" value="3" min="0">
        </div>

        <div class="form-group">
          <label for="autoDebit">
            <input type="checkbox" id="autoDebit">
            Tá»± Ä‘á»™ng thanh toÃ¡n
          </label>
        </div>

        <div class="form-group">
          <label for="notes">Ghi chÃº</label>
          <textarea id="notes" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBillModal()">Há»§y</button>
          <button type="submit" class="btn btn-primary">LÆ°u</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    let bills = [];
    let token = localStorage.getItem('token');

    if (!token) {
      window.location.href = '/';
    }

    async function loadBills() {
      try {
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        let url = '/api/recurring-bills?limit=100';
        if (typeFilter) url += `&type=${typeFilter}`;
        if (statusFilter) url += `&isActive=${statusFilter}`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success) {
          bills = data.data;
          displayBills(bills);
        }
      } catch (error) {
        console.error('Error loading bills:', error);
      }
    }

    function displayBills(billsData) {
      const container = document.getElementById('billsList');

      if (billsData.length === 0) {
        container.innerHTML = '<p>ChÆ°a cÃ³ hÃ³a Ä‘Æ¡n nÃ o.</p>';
        return;
      }

      const table = `
                <table>
                    <thead>
                        <tr>
                            <th>TÃªn</th>
                            <th>Loáº¡i</th>
                            <th>Sá»‘ tiá»n</th>
                            <th>Táº§n suáº¥t</th>
                            <th>NgÃ y Ä‘áº¿n háº¡n</th>
                            <th>Tráº¡ng thÃ¡i</th>
                            <th>Thao tÃ¡c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${billsData.map(bill => `
                            <tr>
                                <td>${bill.name}</td>
                                <td>${getTypeLabel(bill.type)}</td>
                                <td>${bill.amount.toLocaleString('vi-VN')} VNÄ</td>
                                <td>${getFrequencyLabel(bill.frequency)}</td>
                                <td>${new Date(bill.nextDueDate).toLocaleDateString('vi-VN')}</td>
                                <td><span class="badge ${bill.isActive ? 'badge-success' : 'badge-secondary'}">${bill.isActive ? 'Hoáº¡t Ä‘á»™ng' : 'Dá»«ng'}</span></td>
                                <td>
                                    <button class="btn btn-sm" onclick="markAsPaid('${bill._id}')">âœ“ ÄÃ£ thanh toÃ¡n</button>
                                    <button class="btn btn-sm" onclick="editBill('${bill._id}')">âœï¸</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBill('${bill._id}')">ğŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

      container.innerHTML = table;
    }

    async function loadUpcomingBills() {
      try {
        const response = await fetch('/api/recurring-bills/upcoming?days=7', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success) {
          displayUpcomingBills(data.data);
        }
      } catch (error) {
        console.error('Error loading upcoming bills:', error);
      }
    }

    function displayUpcomingBills(billsData) {
      const container = document.getElementById('upcomingBills');

      if (billsData.length === 0) {
        container.innerHTML = '<p>KhÃ´ng cÃ³ hÃ³a Ä‘Æ¡n nÃ o sáº¯p Ä‘áº¿n háº¡n.</p>';
        return;
      }

      const list = billsData.map(bill => `
                <div class="alert alert-warning">
                    <strong>${bill.name}</strong> - ${bill.amount.toLocaleString('vi-VN')} VNÄ
                    <br>Äáº¿n háº¡n: ${new Date(bill.nextDueDate).toLocaleDateString('vi-VN')}
                    <button class="btn btn-sm" onclick="markAsPaid('${bill._id}')">âœ“ ÄÃ£ thanh toÃ¡n</button>
                </div>
            `).join('');

      container.innerHTML = list;
    }

    async function loadStats() {
      try {
        const [statsRes, upcomingRes, overdueRes] = await Promise.all([
          fetch('/api/recurring-bills/stats/summary', {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch('/api/recurring-bills/upcoming?days=7', {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch('/api/recurring-bills/overdue', {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);

        const statsData = await statsRes.json();
        const upcomingData = await upcomingRes.json();
        const overdueData = await overdueRes.json();

        if (statsData.success) {
          document.getElementById('totalMonthly').textContent =
            (statsData.data.monthlyTotal.total || 0).toLocaleString('vi-VN') + ' VNÄ';
        }

        if (upcomingData.success) {
          document.getElementById('upcomingCount').textContent = upcomingData.count || 0;
        }

        if (overdueData.success) {
          document.getElementById('overdueCount').textContent = overdueData.count || 0;
        }

        const activeResponse = await fetch('/api/recurring-bills?isActive=true&limit=1000', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const activeData = await activeResponse.json();
        if (activeData.success) {
          document.getElementById('activeCount').textContent = activeData.data.length;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    function getTypeLabel(type) {
      const labels = {
        'rent': 'Tiá»n nhÃ ',
        'electricity': 'Äiá»‡n',
        'water': 'NÆ°á»›c',
        'internet': 'Internet',
        'parking': 'Gá»­i xe',
        'garbage': 'RÃ¡c',
        'other': 'KhÃ¡c'
      };
      return labels[type] || type;
    }

    function getFrequencyLabel(frequency) {
      const labels = {
        'daily': 'HÃ ng ngÃ y',
        'weekly': 'HÃ ng tuáº§n',
        'monthly': 'HÃ ng thÃ¡ng',
        'quarterly': 'HÃ ng quÃ½',
        'yearly': 'HÃ ng nÄƒm'
      };
      return labels[frequency] || frequency;
    }

    function filterBills() {
      loadBills();
    }

    function showAddBillForm() {
      document.getElementById('modalTitle').textContent = 'ThÃªm HÃ³a ÄÆ¡n Äá»‹nh Ká»³';
      document.getElementById('billForm').reset();
      document.getElementById('billId').value = '';
      document.getElementById('billModal').style.display = 'block';
    }

    function closeBillModal() {
      document.getElementById('billModal').style.display = 'none';
    }

    async function editBill(id) {
      const bill = bills.find(b => b._id === id);
      if (!bill) return;

      document.getElementById('modalTitle').textContent = 'Chá»‰nh Sá»­a HÃ³a ÄÆ¡n';
      document.getElementById('billId').value = bill._id;
      document.getElementById('name').value = bill.name;
      document.getElementById('type').value = bill.type;
      document.getElementById('amount').value = bill.amount;
      document.getElementById('frequency').value = bill.frequency;
      document.getElementById('dueDay').value = bill.dueDay || '';
      document.getElementById('nextDueDate').value = bill.nextDueDate.split('T')[0];
      document.getElementById('reminderDays').value = bill.reminderDays;
      document.getElementById('autoDebit').checked = bill.autoDebit;
      document.getElementById('notes').value = bill.notes || '';
      document.getElementById('billModal').style.display = 'block';
    }

    async function deleteBill(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a hÃ³a Ä‘Æ¡n nÃ y?')) return;

      try {
        const response = await fetch(`/api/recurring-bills/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        if (data.success) {
          alert('XÃ³a hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!');
          loadBills();
          loadStats();
        }
      } catch (error) {
        console.error('Error deleting bill:', error);
        alert('CÃ³ lá»—i xáº£y ra!');
      }
    }

    async function markAsPaid(id) {
      const amount = prompt('Nháº­p sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n:');
      if (!amount) return;

      try {
        const response = await fetch(`/api/recurring-bills/${id}/pay`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            amount: parseFloat(amount),
            paidDate: new Date().toISOString()
          })
        });

        const data = await response.json();
        if (data.success) {
          alert('ÄÃ£ Ä‘Ã¡nh dáº¥u thanh toÃ¡n!');
          loadBills();
          loadUpcomingBills();
          loadStats();
        }
      } catch (error) {
        console.error('Error marking as paid:', error);
        alert('CÃ³ lá»—i xáº£y ra!');
      }
    }

    document.getElementById('billForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const billId = document.getElementById('billId').value;
      const billData = {
        name: document.getElementById('name').value,
        type: document.getElementById('type').value,
        amount: parseFloat(document.getElementById('amount').value),
        frequency: document.getElementById('frequency').value,
        dueDay: parseInt(document.getElementById('dueDay').value) || undefined,
        nextDueDate: document.getElementById('nextDueDate').value,
        reminderDays: parseInt(document.getElementById('reminderDays').value),
        autoDebit: document.getElementById('autoDebit').checked,
        notes: document.getElementById('notes').value
      };

      try {
        const url = billId ? `/api/recurring-bills/${billId}` : '/api/recurring-bills';
        const method = billId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(billData)
        });

        const data = await response.json();
        if (data.success) {
          alert(billId ? 'Cáº­p nháº­t thÃ nh cÃ´ng!' : 'ThÃªm hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!');
          closeBillModal();
          loadBills();
          loadStats();
        }
      } catch (error) {
        console.error('Error saving bill:', error);
        alert('CÃ³ lá»—i xáº£y ra!');
      }
    });

    // Initial load
    loadBills();
    loadUpcomingBills();
    loadStats();
  </script>
  <%- include('partials/footer', { additionalJS: ['/js/auth.js', '/js/recurring-bills.js' ] }) %>
